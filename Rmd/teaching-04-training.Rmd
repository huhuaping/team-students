---
title: "大学生科创项目统计"
author: "胡华平"
date: "`r Sys.Date()`"
output:
  bookdown::word_document2: 
    fig_caption:  true
    toc: no
    toc_depth: 1
    reference_docx: template-post.docx
  bookdown::html_document2:
    css: css/style.css
    highlight: tango
    number_sections: yes
    toc: yes
    fig_caption:  true
    toc_float: true
    mathjax: local
    self_contained: no
always_allow_html: yes
documentclass: article
classoption: [(landscape,a4paper),(portrait,a4paper)]
fontsize: "12pt"
---

```{r global_options, echo=F,message=FALSE,warning=F}
knitr::opts_chunk$set(echo=F, warning=FALSE, message=FALSE,
                      fig.align='center',fig.width=5, fig.height=4) # Places figures on their own pages
options(
  htmltools.dir.version = FALSE, 
  formatR.indent = 2, width = 55, 
  digits = 2,scipen=999,tinytex.verbose = TRUE,
  knitr.kable.NA = '',
  fig.width=12, fig.height=8)
library('bookdown')
library('knitr')
library('xlsx')
library("openxlsx")
#install.packages('tidyr')
#install.packages('plyr')
library('tidyr')
library('dplyr')
library('stringr')
library('tidyverse')
library('ggplot2')
library("scales")
#install.packages("gridExtra")
library("gridExtra")
#install.packages("magrittr")
library("magrittr")
#install.packages("ggthemes")
#install.packages("ggrepel")
require("ggthemes")
require("ggrepel")
require("lubridate")
require("here")
require('simstudy')
require('fansi')
```


# 清洗数据

```{r, echo=TRUE}
# 读取数据
df <- openxlsx::read.xlsx("../data/training-proj-2017-2020.xlsx")

# 清洗数据、计算得分
df_tidy <- df %>%
  rename("负责人0" = "负责人学号") %>%
  gather(key = "menmber", value = "id_menmber", `负责人0`,`成员1`:`成员5`) %>%
  arrange(desc(`立项年份`), `项目编号`) %>%
  filter(!is.na(id_menmber)) %>%
  mutate(order_menmber = as.numeric(str_extract(menmber, "\\d{1}")),
         score_minus = order_menmber *0.5,
         score_base = ifelse(`项目等级`=="国家级", 3,
                             ifelse(`项目等级`=="省级", 2.5, 2)),
         proj_status = ifelse(is.na(`项目状态`), "未知", `项目状态`),
         score_status = ifelse(str_detect(proj_status,"中止"), 0, 1)) %>%
  filter(score_status ==1) %>%
  mutate(score_get = score_status*(score_base - score_minus)) 
  
# 计算最高得分（不重复、不累加）
df_smry <- df_tidy %>%
  group_by(id_menmber) %>%
  summarise(score_max = max(score_get)) %>%
  mutate(score_final = ifelse(score_max < 1, 1, score_max)) %>%
  mutate(status_ok = ifelse(score_final >=2, "OK", "fail"),
         ID = as.numeric(str_extract(id_menmber, "\\d{4}")))
```

# 计算步骤和计算公式

计算步骤：

1). 分析参与排序`order_menmber`：主持人（0）；成员1（1）；成员2（2）；...

1). 计算基础得分`score_base`：国家级3分；省级2.5分；校级2分。

1). 计算递减得分`score_minus`：=`0.5*order_menmber`。参与排序乘以0.5的递减分数。

1). 分析项目状态`score_status`：中止=0， 其他（结题、在研...）=1

1). 计算项目得分`score_get`：=`score_status*(score_base - score_minus )`

1). 计算保底得分`score_final`：如果项目得分<0.5，则记为1分。

1). 计算每个学生的最高得分`score_max`：根据学号，用`max()`函数找到所有同学的最高得分。


项目得分的计算公式：

$$score\_get= score\_status*(score\_base - score\_minus )$$

# 统计分析结果

下面表\@ref(tab:tab-value)给出了2017级学生科创项目参与不同**得分**水平下的人次和百分比情况。


```{r tab-value}
names_chn <- c("得分", "人数", "百分比")
df_smry %>%
  filter(ID == 2017) %>%
  janitor::tabyl(score_final) %>%
  janitor::adorn_totals(c("row")) %>%
  janitor::adorn_pct_formatting() %>%
  rename_at(vars(names(.)), ~all_of(names_chn)) %>%
  kable(caption = "2017级学生科创项目参与得分的人次和百分比")
```

> **说明**：
1)项目状态为“中止”的学生没有统计在内（根据规定，主持人和参与人都不能获得分数）。
2)学号异常的学生没有包括在内（可能是访学学生）。

</br>

下面表\@ref(tab:tab-status)给出了2017级学生科创项目参与**得分状态**的人次和百分比情况。


```{r tab-status}
names_chn <- c("得分状态", "人数", "百分比")

df_smry %>%
  filter(ID == 2017) %>%
  janitor::tabyl(status_ok) %>%
  janitor::adorn_totals(c("row")) %>%
  janitor::adorn_pct_formatting() %>%
  mutate(status_ok = mgsub::mgsub(status_ok, 
                                  c("fail", "OK", "Total"),
                                  c("小于2分", "2分及以上", "合计"))) %>%
  rename_at(vars(names(.)), ~all_of(names_chn)) %>%
  kable(caption = "2017级学生科创项目参与得分状态的人次和百分比")
```


